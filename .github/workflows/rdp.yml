name: üåÄ ZUN CLOUD - PUBLIC RDP
on:
  workflow_dispatch:
    inputs:
      user_id:
        description: 'User ID'
        required: true
      user_email:
        description: 'User Email'
        required: true

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: üöÄ KH·ªûI T·∫†O
        run: |
          echo "=================================================="
          echo "üõ°Ô∏è  ZUN CLOUD - PUBLIC RDP SYSTEM"
          echo "üë§ User: ${{ github.event.inputs.user_id }}"
          echo "üìß Email: ${{ github.event.inputs.user_email }}"
          echo "‚è∞ $(Get-Date -Format 'dd/MM/yyyy HH:mm:ss')"
          echo "=================================================="

      - name: üîê T·∫†O ADMINISTRATOR
        run: |
          # T·∫°o password random
          $Password = "Admin-" + -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | ForEach-Object {[char]$_})
          $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
          
          # Set password cho Administrator
          Get-LocalUser -Name "Administrator" | Set-LocalUser -Password $SecurePassword
          Enable-LocalUser -Name "Administrator"
          
          # L∆∞u v√†o environment
          echo "ADMIN_PASSWORD=$Password" >> $env:GITHUB_ENV
          echo "‚úÖ Administrator password: $Password"

      - name: ‚öôÔ∏è C·∫§U H√åNH RDP
        run: |
          echo "‚öôÔ∏è Configuring RDP..."
          
          # B·∫≠t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # Firewall cho RDP
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          echo "‚úÖ RDP configured!"

      - name: üåê T·∫¢I V√Ä CH·∫†Y KAMI TUNNEL
        id: tunnel
        run: |
          echo "üåê Downloading kami-tunnel..."
          
          # T·∫£i kami-tunnel
          Invoke-WebRequest -Uri "https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz" -OutFile "kami-tunnel.tar.gz"
          
          # Gi·∫£i n√©n
          tar -xzf kami-tunnel.tar.gz
          
          echo "üöÄ Starting tunnel on port 3389..."
          
          # Ch·∫°y kami-tunnel (background)
          Start-Process -FilePath ".\kami-tunnel.exe" -ArgumentList "3389" -WindowStyle Hidden -RedirectStandardOutput "tunnel-output.txt"
          
          # ƒê·ª£i 10 gi√¢y ƒë·ªÉ tunnel kh·ªüi ƒë·ªông
          Start-Sleep -Seconds 10
          
          # L·∫•y public IP:PORT t·ª´ output
          $TunnelOutput = Get-Content "tunnel-output.txt" -Raw
          
          # Parse IP:PORT (v√≠ d·ª•: "Your public address: 123.45.67.89:12345")
          if ($TunnelOutput -match "(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+)") {
            $PublicAddress = $Matches[1]
            echo "PUBLIC_IP=$PublicAddress" >> $env:GITHUB_OUTPUT
            echo "PUBLIC_ADDRESS=$PublicAddress" >> $env:GITHUB_ENV
            echo "‚úÖ Public address: $PublicAddress"
          } else {
            # Fallback: ƒê·ªçc t·ª´ API ho·∫∑c log
            $PublicAddress = "ƒêang c·∫≠p nh·∫≠t..."
            echo "PUBLIC_IP=$PublicAddress" >> $env:GITHUB_OUTPUT
            echo "‚ö†Ô∏è Kh√¥ng parse ƒë∆∞·ª£c IP, check tunnel-output.txt"
          }

      - name: üíæ C·∫¨P NH·∫¨T FIREBASE
        run: |
          echo "üíæ Updating Firebase..."
          
          $UserID = "${{ github.event.inputs.user_id }}"
          $FirebaseURL = "${{ secrets.FIREBASE_URL }}/users/$UserID/vms.json"
          
          $VMData = @{
            id = (New-Guid).ToString()
            os = "Windows Server 2022"
            ip = "${{ steps.tunnel.outputs.PUBLIC_IP }}"
            username = "Administrator"
            password = "${{ env.ADMIN_PASSWORD }}"
            created = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss")
            expires = (Get-Date).AddHours(6).ToString("yyyy-MM-ddTHH:mm:ss")
            status = "running"
          } | ConvertTo-Json
          
          try {
            Invoke-RestMethod -Uri $FirebaseURL -Method Post -Body $VMData -ContentType "application/json" -ErrorAction SilentlyContinue
            echo "‚úÖ Firebase updated!"
          } catch {
            echo "‚ö†Ô∏è Firebase update failed: $_"
          }

      - name: üìß G·ª¨I EMAIL CHO USER
        run: |
          echo "üìß Sending email..."
          
          $UserEmail = "${{ github.event.inputs.user_email }}"
          $PublicIP = "${{ steps.tunnel.outputs.PUBLIC_IP }}"
          $Password = "${{ env.ADMIN_PASSWORD }}"
          
          # HTML Email Template
          $EmailBody = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { background: white; border-radius: 10px; padding: 30px; max-width: 600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .content { padding: 20px 0; }
        .info-box { background: #f9fafb; border-left: 4px solid #667eea; padding: 15px; margin: 10px 0; }
        .info-box strong { color: #667eea; }
        .footer { text-align: center; color: #999; font-size: 12px; padding-top: 20px; }
        code { background: #e5e7eb; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>ZUN CLOUD</h1>
            <p>May ao cua ban da san sang</p>
        </div>
        <div class='content'>
            <h2>Thong tin ket noi RDP</h2>
            <div class='info-box'>
                <strong>IP PORT:</strong> <code>$PublicIP</code>
            </div>
            <div class='info-box'>
                <strong>Username:</strong> <code>Administrator</code>
            </div>
            <div class='info-box'>
                <strong>Password:</strong> <code>$Password</code>
            </div>
            <div class='info-box'>
                <strong>Thoi gian:</strong> <code>6 gio</code>
            </div>
            <h3>Cach ket noi:</h3>
            <ol>
                <li>Tai Microsoft Remote Desktop</li>
                <li>Tao ket noi moi voi IP:PORT phia tren</li>
                <li>Nhap Username va Password</li>
                <li>Bat dau su dung</li>
            </ol>
            <p><strong>Luu y:</strong> May se tu dong tat sau 6 gio.</p>
        </div>
        <div class='footer'>
            <p>2025 ZUN CLOUD</p>
        </div>
    </div>
</body>
</html>
"@
          
          # G·ª≠i qua SendGrid/Gmail API (c·∫ßn config secret)
          # Ho·∫∑c d√πng PowerShell Send-MailMessage n·∫øu c√≥ SMTP
          
          # V√≠ d·ª• v·ªõi Gmail SMTP
          try {
            $SMTPServer = "smtp.gmail.com"
            $SMTPPort = 587
            $SMTPUser = "${{ secrets.SMTP_USER }}"
            $SMTPPassword = ConvertTo-SecureString "${{ secrets.SMTP_PASSWORD }}" -AsPlainText -Force
            $Credential = New-Object System.Management.Automation.PSCredential($SMTPUser, $SMTPPassword)
            
            Send-MailMessage -From "noreply@zuncloud.com" `
                             -To $UserEmail `
                             -Subject "‚òÅÔ∏è M√°y ·∫£o ZUN CLOUD c·ªßa b·∫°n ƒë√£ s·∫µn s√†ng!" `
                             -Body $EmailBody `
                             -BodyAsHtml `
                             -SmtpServer $SMTPServer `
                             -Port $SMTPPort `
                             -UseSsl `
                             -Credential $Credential
            
            echo "‚úÖ Email sent to $UserEmail"
          } catch {
            echo "‚ö†Ô∏è Email failed: $_"
            echo "Fallback: Update Firebase with credentials"
          }

      - name: üîí CH·∫∂N C·ªîNG NGUY HI·ªÇM
        run: |
          echo "üîí Blocking dangerous ports..."
          
          $DangerousPorts = @(3333, 4444, 5555, 8888, 9999, 14433, 14444, 45560)
          
          foreach ($Port in $DangerousPorts) {
            New-NetFirewallRule -DisplayName "Block_$Port" -Direction Outbound -LocalPort $Port -Protocol TCP -Action Block -ErrorAction SilentlyContinue
          }
          
          echo "‚úÖ Blocked $($DangerousPorts.Count) ports!"

      - name: ‚ö° DUY TR√å 6 GI·ªú
        run: |
          echo "‚ö° VM running for 6 hours (360 minutes)..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          $UserID = "${{ github.event.inputs.user_id }}"
          $CommandURL = "${{ secrets.FIREBASE_URL }}/users/$UserID/command.json"
          
          for ($i = 1; $i -le 360; $i++) {
            # Ki·ªÉm tra l·ªánh stop t·ª´ web
            try {
              $Command = Invoke-RestMethod -Uri $CommandURL -Method Get -ErrorAction SilentlyContinue
              
              if ($Command -eq "stop") {
                echo ""
                echo "‚õî User requested stop!"
                
                # Update Firebase
                $StopURL = "${{ secrets.FIREBASE_URL }}/users/$UserID/vms.json"
                $StopData = @{ status = "stopped" } | ConvertTo-Json
                Invoke-RestMethod -Uri $StopURL -Method Patch -Body $StopData -ContentType "application/json" -ErrorAction SilentlyContinue
                
                echo "‚úÖ VM stopped by user request"
                exit 0
              }
            } catch {}
            
            # Progress
            $Remaining = 360 - $i
            $Hours = [math]::Floor($Remaining / 60)
            $Minutes = $Remaining % 60
            
            Write-Host "‚è±Ô∏è  Ph√∫t $i/360 | C√≤n: ${Hours}h ${Minutes}m | IP: ${{ steps.tunnel.outputs.PUBLIC_IP }}" -NoNewline
            Write-Host "`r" -NoNewline
            
            Start-Sleep -Seconds 60
          }
          
          echo ""
          echo "‚è∞ Time's up! VM will shutdown."

      - name: üîö K·∫æT TH√öC
        if: always()
        run: |
          echo "üîö Cleaning up..."
          
          # Stop kami-tunnel
          Stop-Process -Name "kami-tunnel" -Force -ErrorAction SilentlyContinue
          
          # Update Firebase
          $UserID = "${{ github.event.inputs.user_id }}"
          $VMURL = "${{ secrets.FIREBASE_URL }}/users/$UserID/vms.json"
          
          $FinalData = @{
            status = "stopped"
            stopped_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss")
          } | ConvertTo-Json
          
          try {
            Invoke-RestMethod -Uri $VMURL -Method Patch -Body $FinalData -ContentType "application/json" -ErrorAction SilentlyContinue
            echo "‚úÖ Firebase updated!"
          } catch {
            echo "‚ö†Ô∏è Cleanup failed"
          }
          
          echo "üéâ ZUN CLOUD - Session ended"
